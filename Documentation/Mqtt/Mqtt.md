![](/Documentation/Images/Net2HassMqtt_banner_820x70.png)

# MQTT

While the library is intended to be used without much MQTT or Home Assistant (Home Assistant) MQTT usage this section provides more details and links for those who wish to dive a bit deeper.

## Table of Contents

- [Entity Status/Set Messaging](#entity-statusset-messaging)
  - [Topics](#topics)
  - [State Payloads](#state-payloads)
- [Last Will and Testament (LWT)](#last-will-and-testament-lwt)
- [Home Assistant Discovery](#home-assistant-discovery)
- [Examples](#examples)


## Entity Status/Set Messaging

### Topics

Entity command and state topic format is:

> \<client ID>/\<device ID>/\<entity node ID>[/\<action>]

Where:

* **client ID** - Is the Net2HassMqtt created MQTT client ID.
* **device ID** - Is the device's ID. Used to group entities by device.
* **entity node ID** - Is the entity's node ID within the device. This is a suffix in the entity's `object_id`.
* **action** - Identifes the topic's type such as or `set`. Ommitted for status updates.

Examples:

> `net2hassmqtt/watering_controller_1/zone__pots_is_watering`
> `net2hassmqtt_quick_start/net2hassmqtt_quick_start_device_01/battery_1_charging/set`


### State Payloads

Example state payload:

```json
{
  "attributes": {},
  "state": "ON"
}
```

Attributes appear in the state payload `data` property.


## Last Will and Testament (LWT)

MQTT has a feature of a Last Will and Testament (LWT) message that a client registers with the broker to be sent to subscribers if/when the client's connection is lost (this may be a timeout).
So if the Net2HassMqtt application shutsdown uncontrolled (crashes), subscribers will still get the LWT message.

On connecting to the MQTT broker, Net2HassMqtt sends a birth message to set its availability status to "on-line".
On a controlled shutdown it sends the LWT which sets the status to "off-line".
For the broker to send a LWT (if there is an uncontrolled shutdown) the LWT message must be configured in the underlying MQTTnet options.

The MQTT client's status topic is:

> \<MQTT client ID\>/bridge/status

e.g:

> net2hassmqtt/bridge/status

All entities have availability set to use the Net2HassMqtt client's online status.
So when the client become unavailable (off-line) all of the client's entities will show in Home Assistant as unavailable.

## Home Assistant Discovery

The Home Assistant discovery MQTT topic format is:

> \<Home Assistant client ID>/\<component>/\<device ID>/\<entity ID>/config

Where:

* **Home Assistant client ID** - Is the Home Assistant MQTT name. The default name is `homeassistant`.
* **component** - Is the entity domain like `binary_sensor` or `sensor`.
* **device ID** - Is the device's ID. Home Assistant ignores this. Used to group entities by device.
* **entity ID** - Is the entity's `unique_id`. It includes the device ID as a prefix.

For information on Home Assistant discovery see:

* https://www.home-assistant.io/integrations/mqtt/#mqtt-discovery

The JSON payload can largly be inferred from the Home Assistant yaml documentation here:

* https://home-assistant-china.github.io/components/switch.mqtt/
* https://home-assistant-china.github.io/components/sensor.mqtt/

A sample Net2HassMqtt MQTT message payload generated by the Quick Start Demo App code in the repository.

__Topic:__

> `homeassistant/binary_sensor/net2hassmqtt_quick_start_device_01/net2hassmqtt_quick_start_device_01_battery_1_charging/config`

__Payload:__

```json
{
  "device_class": "battery_charging",
  "unit_of_measurement": "none",
  "availability": {
    "payload_available": "online",
    "payload_not_available": "offline",
    "topic": "net2hassmqtt_quick_start/bridge/state",
    "value_template": "{{ value_json.state }}"
  },
  "device": {
    "identifiers": [
      "net2hassmqtt_quick_start_device_01"
    ],
    "manufacturer": "",
    "model": "",
    "name": "Net2HassMqtt Quick Start Device 1"
  },
  "json_attributes_template": "{{ value_json.data | tojson }}",
  "json_attributes_topic": "net2hassmqtt_quick_start/net2hassmqtt_quick_start_device_01/battery_1_charging",
  "name": "Battery Charging Status",
  "object_id": "net2hassmqtt_quick_start_device_01_battery_1_charging",
  "state_topic": "net2hassmqtt_quick_start/net2hassmqtt_quick_start_device_01/battery_1_charging",
  "unique_id": "net2hassmqtt_quick_start_device_01_battery_1_charging",
  "value_template": "{{ value_json.state }}"
}
```

## Examples

Example MQTT messages.

### Home Assistant Discovery

Entity configuration messages.

#### TemperatureNumber

Topic:

> `homeassistant/number/net2hassmqtt_test_device_03/net2hassmqtt_test_device_03_temperature/config`

Message:

```json
{
  "command_topic": "",
  "device_class": "temperature",
  "unit_of_measurement": "\u00B0C",
  "availability": {
    "payload_available": "online",
    "payload_not_available": "offline",
    "topic": "net2hassmqtt_test_app_1/bridge/state",
    "value_template": "{{ value_json.state }}"
  },
  "device": {
    "identifiers": [
      "net2hassmqtt_test_device_03"
    ],
    "manufacturer": "",
    "model": "",
    "name": "Net2HassMqtt Number Test Device"
  },
  "json_attributes_template": "{{ value_json.data | tojson }}",
  "json_attributes_topic": "net2hassmqtt_test_app_1/net2hassmqtt_test_device_03/temperature",
  "name": "Temperature",
  "object_id": "net2hassmqtt_test_device_03_temperature",
  "state_topic": "net2hassmqtt_test_app_1/net2hassmqtt_test_device_03/temperature",
  "unique_id": "net2hassmqtt_test_device_03_temperature",
  "value_template": "{{ value_json.state }}"
}
```

#### BatteryBinarySensor

Topic:

> `homeassistant/binary_sensor/net2hassmqtt_test_device_01/net2hassmqtt_test_device_01_battery_status/config`

Message:

```json
{
  "device_class": "battery",
  "unit_of_measurement": "none",
  "availability": {
    "payload_available": "online",
    "payload_not_available": "offline",
    "topic": "net2hassmqtt_test_app_1/bridge/state",
    "value_template": "{{ value_json.state }}"
  },
  "device": {
    "identifiers": [
      "net2hassmqtt_test_device_01"
    ],
    "manufacturer": "",
    "model": "",
    "name": "Net2HassMqtt Binary Sensor Test Device"
  },
  "json_attributes_template": "{{ value_json.data | tojson }}",
  "json_attributes_topic": "net2hassmqtt_test_app_1/net2hassmqtt_test_device_01/battery_status",
  "name": "Battery Status",
  "object_id": "net2hassmqtt_test_device_01_battery_status",
  "state_topic": "net2hassmqtt_test_app_1/net2hassmqtt_test_device_01/battery_status",
  "unique_id": "net2hassmqtt_test_device_01_battery_status",
  "value_template": "{{ value_json.state }}"
}
```

#### Switch

Topic:

> `homeassistant/switch/net2hassmqtt_test_device_04/net2hassmqtt_test_device_04_switch_1/config`

Message:

```json
{
  "command_topic": "",
  "payload_off": "OFF",
  "payload_on": "ON",
  "availability": {
    "payload_available": "online",
    "payload_not_available": "offline",
    "topic": "net2hassmqtt_test_app_1/bridge/state",
    "value_template": "{{ value_json.state }}"
  },
  "device": {
    "identifiers": [
      "net2hassmqtt_test_device_04"
    ],
    "manufacturer": "",
    "model": "",
    "name": "Net2HassMqtt Switch Test Device"
  },
  "json_attributes_template": "{{ value_json.data | tojson }}",
  "json_attributes_topic": "net2hassmqtt_test_app_1/net2hassmqtt_test_device_04/switch_1",
  "name": "Switch 1",
  "object_id": "net2hassmqtt_test_device_04_switch_1",
  "state_topic": "net2hassmqtt_test_app_1/net2hassmqtt_test_device_04/switch_1",
  "unique_id": "net2hassmqtt_test_device_04_switch_1",
  "value_template": "{{ value_json.state }}"
}
```

